## Table of content

- [Summary](#summary)
- [System requirement](#system-requirement)
- [Installation](#installation)
- [Getting started](#getting-started)
  - [1. Describe motifs and metaPattern](#1-describe-motifs-and-metapattern)
  - [2. Describe genomes](#2-describe-genomes)
    - [2.1 Download genomes](#21-download-genomes)
    - [2.2 Describe genomes in `genomes.txt` configuration file](#22-describe-genomes-in-genomestxt-configuration-file)
  - [3. Edit global `conf.txt` configuration file](#3-edit-global-conftxt-configuration-file)  
  - [4. Run workflow](#4-run-workflow)
- [Workflow description](#workflow-description)
  - [Configuration files](#configuration-files-)
    - [config.txt](#configtxt)
    - [patterns.txt](#patternstxt)
    - [genomes.txt](#genomestxt)
  - [Step 0 **PRepare Genomes**: preparation of genomes for analysis](#step-0-download-genomes)
    - [findGenomesUrl.py](#findGenomesUrl.py) 
    - [Step 0.1 : download prot genomes](#step-01-download-genomes)
  - [Step 1 **COmbine**: motifs detection and metaPattern identification](#step-1-combine-motifs-detection-and-metapattern-identification)
    - [Step 1.1 : run FuzzPro on genomes](#step-11-run-fuzzpro-on-genomes)
    - [Step 1.2 : convert FuzzPro results to tsv](#step-12-convert-fuzzpro-results-to-tsv)
    - [Step 1.3 : Convert Genomes fasta files to tsv](#step-13-convert-genomes-fasta-files-to-tsv)
    - [Step 1.4 : global pattern identification](#step-14-global-pattern-identification)
    - [Step 1.5 : merge results of previous step in one and calculate distance](#step-15-merge-results-and-calculate-distance)
  
## Summary

This workflow  identifies in whole genomes motifs that appear in a precise order defining a global pattern.

## System requirement

This workflow runs on UNIX operating systems.

## Installation

Clone the workflow github repository: 

`git clone https://github.com/cgbaboua/DGAT3_2023.git`

Install the following dependencies :  
- [EMBOSS](http://emboss.open-bio.org/) (Software suite containing FuzzPro), then specify the location of the FuzzPro binary file `fuzzPro_bin` in the configuration file [`conf/config.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/config.txt)

## Getting started

### 1. Describe motifs and metaPattern

Edit the file [`conf/patterns.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/patterns.txt) to describe the individuals motifs which contitute the researched metaPattern. 

In the file [`conf/config.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/config.txt) :

- Specify the metaPattern `GlobalPattern` to describe global pattern using the OneCode letter of each motif composing the metaPattern.
- Specify the `patternsToReport` using the OneCode letter of motifs. Sequences containing one of theses motifs will be reported in results files and displayed in results interface.

#### Example:
This example describe the definition of the BVMO type 1 metaPattern.

##### [`conf/patterns.txt`]([https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/patterns.txt)

| Name | Pattern | OneCode |
| ------ | ------ | ------ |
| BVMO1 | [AG]GxWxxxx[FY]P[GM]xxxD | B |
| BVMO2 | FxGxxxHxxxW[PD] | V |
| Rossmann | GxGxx[GA] | R |

##### conf.txt

The metaPattern of the BVMO type 1 enzymatic signature correspond to the three motifs occurring in the following order : Rossman - BVMO1 - BVMO2 - Rossman

The definition of this metaPattern using the one letter code of each pattern will be as follows:   
`GlobalPattern="RBVR"`

We want to display all sequences which contain at least one BVMO1 or BVMO2:  
`patternsToReport="BV"`

### 2. Describe genomes

#### 2.1 Download genomes

For each genome, you need to provide the download URL of the genome in FASTA format. This information should be included in the `genomes.txt` file.

_Note : If you do not want to manually enter the download URLs for each genome one by one, you can use the [`findGenomesUrl.py`](https://github.com/cgbaboua/DGAT3_2023/tree/main/python) script to facilitate this process. Then, replace the `genomes.txt` file with the output file generated by the script._

#### 2.2 Describe genomes in [`genomes.txt`](-(https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/genomes.txt) file (see the [`genomes.txt`](#genomestxt) configuration file section for explanations)

### 3. Edit global `conf.txt` configuration file  

Specifiy the value of `Project` folder. By default, all other locations (scripts, data, results) will be subfolder of this one. all other locations  are dependent.

Check that the locations of dependencies softwares are specified (cf [`installation`](#installation) section) : `fuzzPro_bin`, `condaEnvMMseq`, `condaEnvMMseq`, `mview_bin`.

### 4. Run workflow 

All scripts needed to run the workflow are located in the `sh` directory.  
To execute the workflow, you can run the script **run_COSP.sh**, or manually run the scripts `step*` in the following order :
- step0.1_download_genomes.sh
- step1.1_run_FuzzPro_on_genomes.sh
- step1.2_convert_FuzzPro_results_to_tsv.sh
- step1.3_convert_genomes_fasta_files_to_tsv.sh
- step1.4_global_patterns_identification.sh
- step1.5_merge_results_and_calculate_distance.sh

_Note : if you use COSP on sge cluster (`use_cluster="YES"`), you need to run all-step manually._ 

## Workflow description 

### Configuration files :

#### [`config.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/config.txt) 

File containing all parameters used in the workflow.

#### [`patterns.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/patterns.txt) 

File describing all motifs searched in fasta sequences with fuzzpro with the following information :
- Name : pattern name 
- Pattern : pattern definition in [PROSITE pattern notation](https://en.wikipedia.org/wiki/Sequence_motif#Pattern_description_notations)
- OneCode : pattern ONE LETTER code. This code will be used to define the global metaPattern identified with by workflow (see `GlobalPattern` and `patternsToReport` parameters in [`config.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/config.txt) file).

_Notes :_
- _the file header is mandatory_
- _all fields are mandatory_

#### [`genomes.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/genomes.txt)

File describing all genomes in which patterns and the metapattern will be searched. Each genome is described by the following information :
- Name : Genome Name 
- Accession ID : Accession number _(not used)_
- File : name of fasta file containing all fasta sequences of the genome. 
- Taxon ID : Taxonomy ID _(not used)_
- URL : Genomes download link

### Step 0 **PRepare Genomes**: preparation of genomes data for analysis
#### findGenomesUrl.py : 
Its main function is to automatically generate download URLs for protein       sequences genome based on their accession numbers and complete names, which it then writes into an output file. This facilitates the use of the workflow by automating the process of populating the [`genomes.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/genomes.txt) file.

##### Prerequisites :
- Python 3.6 or a higher version
- An operating system that supports Python
- A dataset file in TSV format, which should be downloaded from the [`NCBI data hub`](https://www.ncbi.nlm.nih.gov/data-hub/genome/). This dataset should at a minimum contain the GenBank accession number named 'Assembly Accession' (this should be the first column) and the 'Assembly Name' of each genome. It's also possible to include the 'Scientific Name' column, which provides the scientific name of the organism and thus facilitates understanding of future results. If the 'Scientific Name' is not provided in one of the TSV columns, the organism's name will default to the 'Assembly Name'.

_Note: without this dataset, the script will not function correctly. Make sure you have the correct file before running the script, and ensure it is in TSV format._
 
 ##### Getting started :
Run the script from the command prompt or terminal. The script requires the input of certain information, specifically the name of the output file and the path to the input file. Specify this information. As :

```
% python3 url.py ncbi_dataset.tsv filout.txt

```
The input file should be the dataset previously retrieved from the [`NCBI data hub`](https://www.ncbi.nlm.nih.gov/data-hub/genome/).

##### Outputs :
The output file will take the form of the [`genomes.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/genomes.txt) file needed to launch the workflow, but it will take the name that you decide to give it. 
It is recommended to name it directly as [`genomes.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/genomes.txt) so you simply have to move it to the workflow tool's configuration directory, [`conf`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/), at the end of the script. 
It will contain the following columns: Name, AccessionID, File, TaxonID, URL.

_Notes :_ 
- *The 'TaxonID' will be replaced by 0, as it's not required for the COSP workflow steps*
- *Before running this script, ensure that the input dataset file and output file names are fully specified, including their extensions*
- *Also, ensure that the output file name given does not already exist.*


 #### Step 0.1: download genomes 

This step initiates the automated process of downloading, decompressing, and preparing genomes for subsequent steps of analysis. It uses the URLs provided in the `genomes.txt` file to obtain the necessary genomes and prepares them for further processing.

- script :  [`step0.1_download_genomes.sh`](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/step0.1_download_genomes.sh)  
- process location : local|cluster

##### Prerequisites :

- URLs for the download of each genome included in the genomes.txt file.
- config.txt configuration file containing information such as the location of the genomes directory, user email, whether an SGE cluster is being used, and the SGE queue.
- Necessary downloading and decompression tools installed on the local machine.

##### Options : 

##### Outputs :

For each genome specified in the genomes.txt file, a corresponding downloaded and decompressed fasta file.
Output files are located in the Genomes_folder, with the following nomenclature:
${genome_name}.fasta

_Note : The ${genome_name} in the file name is derived from the URLs provided in the genomes.txt file. Make sure these URLs are accurate and accessible to ensure the correct operation of the script._

### Step 1 **COmbine**: motifs detection and metaPattern identification 

 #### Step 1.1: run FuzzPro on genomes

This step launch FuzzPro to identify each pattern (defined in [`conf/patterns.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/patterns.txt) in each genome (defined in [`genomes.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/genomes.txt)

- script :  [`step1.1_run_FuzzPro_on_genomes.sh`](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/step1.1_run_FuzzPro_on_genomes.sh)  
- process location : local|cluster

##### Prerequisites :

- individual sequences patterns described in `patterns.txt` configuration file
- genomes fasta files described in [`genomes.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/genomes.txt) configuration file and located in `Genomes_folder`
- fuzzPro executable location defined in `fuzzPro_bin`

##### Options : 

##### Outputs : 
 
One fuzzpro result file in 'EMBOSS SeqTable' format for each pair genome <-> pattern.  
Output files are located in `fuzzPro_folder`, with the following nomenclature :
`${genome_name}_vs_${pattern_name}.fuzz.txt`

 #### Step 1.2: convert FuzzPro results to tsv 

This step will convert FuzzPro results in EMBOSS SeqTable format to custom tsv files. These tabulate files will contain only information needed for next step in a more convenient format to manipulate.

- script : [`step1.2_convert_FuzzPro_results_to_tsv.sh`](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/step1.2_convert_FuzzPro_results_to_tsv.sh)
- process location : local

##### Prerequisites :

* individual patterns described in $Conf_patterns configuration file
* genomes described in `Conf_genomes` configuration file 
* output files from step1.
* shell script [`convert_EMBOSS_SeqTable_to_custom_tsv_format.sh`](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/convert_EMBOSS_SeqTable_to_custom_tsv_format.sh) located in `sh_folder`.

##### Options : 

##### Outputs :

One tabulate result file per genome.  
Output files are located in `fuzzPro_folder`, with the following nomenclature :
`${genome_name}.fuzz.tsv`
Results files contains one line per pattern hit per genome. Each line is structured in columns as follow :  
- **Genome** : genome name
- **Pattern_name** : pattern name
- **Pattern** : pattern definition
- **Sequence**: identifier of the sequence in which Pattern was found
- **Sequence_size**: size of the sequence in which Pattern was found
- **start**: start position of observed pattern in the Sequence
- **stop**: stop position of observed pattern in the Sequence
- **mismatch**: nb of mismatches between original pattern and observed pattern
- **observed_seq**: observed pattern sequence
- **code**: pattern code

 ### Step 1.3: Convert Genomes fasta files to tsv 

This step will convert genome fasta files in tabulate format.

- script : [step1.3_convert_genomes_fasta_files_to_tsv.sh](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/step1.3_convert_genomes_fasta_files_to_tsv.sh)
- process location : local

##### Prerequisites :

* genomes fasta files described in $Conf_genomes configuration file and located in `Genomes_folder`
* shell script [convert_fasta_to_tabulate.sh](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/convert_fasta_to_tabulate.sh) located in `sh_folder`.

##### Options : 

##### Outputs :

One tabulate file per genome.  
Output files are located in `Genomes_folder`, with the following nomenclature :
`${genome_fasta_file}.annot.tsv`
Results files contains one line per genome sequence. Each line is structured in columns as follow :  
- **protein_id** : Sequence identifier extract form the fasta header of the sequence
- **Raw annotation** : Sequence annotation : all information found after the first space in the fasta header of the sequence.
- **Sequence** : Sequence

 #### Step 1.4: global pattern identification

This step will combine positions of each pattern to **identify the global pattern** on each genomes sequences. All sequences which carry at least one individual pattern to report will be reported.

- script : [`step1.4_global_patterns_identification.sh`](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/step1.4_global_patterns_identification.sh)
- process location : local

##### Prerequisites :

* genomes fasta files described in $Conf_genomes configuration file and located in `Genomes_folder`
* individual patterns described in $Conf_patterns configuration file
* output files from step1.3.
* shell script [`analyse_patterns_globaly_and_create_resume_file.sh`](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/analyse_patterns_globaly_and_create_resume_file) located in `sh_folder`.

##### Options : 

Following options can be modified in [`config.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/config.txt) configuration file :
- `GlobalPattern` : definition on the global pattern to identify. It consists of a sequence of individual patterns codes (defined in [`conf/patterns.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/patterns.txt) configuration file). 
- `patternsToReport` : definition of the patterns whose presence is sufficient to report the sequence. It consists of a string of individual patterns codes (defined in [`conf/patterns.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/patterns.txt) configuration file).

##### Outputs :

One tabulate file per genome.  
Output files are located in `fuzzPro_folder`, with the following nomenclature :
`${genome_fasta_file}_resume_fuzzpro.txt`
Results files contains one line per reported genome sequence. Each line is structured in columns as follow : 
- **genome** : genome name  
- **prot_id** : sequence ID 
- **annot** : sequence annotation 
- **global_pattern_RBVR** :  `Yes` if global pattern was found in the sequence. 
- **observed_pattern** :  real observed pattern using patterns codes  
- **one column for each pattern**, with pattern name as header and containing all patterns locations described as follow : {observed_pattern_sequence_1}:{start}-{stop}, {observed_pattern_sequence_2}:{start}-{stop}, etc...
- **distance**,this column is present only if `pattern_dist` is set to yes in [`config.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/config.txt) configuration file : distance between each patterns, which is filled with `xxx` when at least two patterns are found in the sequence 
- **length_seq** : length of sequence
- **sequence** : gene/protein sequence

#### Step 1.5: merge results and calculate distance

This step merges the results from the previous step to create one comprehensive result file. If specified in the configuration, it also calculates the distance between patterns.

- script : [`step1.5_global_patterns_identification.sh`](https://github.com/cgbaboua/DGAT3_2023/blob/main/sh/step1.5_global_patterns_identification.sh)
- process location : local

##### Prerequisites :

* genomes fasta files described in $Conf_genomes configuration file and located in `Genomes_folder`
* individual patterns described in $Conf_patterns configuration file
* output files from step1.4

##### Options : 

Following option can be modified in the [`config.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/config.txt) configuration file :
- **pattern_dist** : if set to "yes", the distances between patterns will be calculated

##### Outputs :

A single tabulated file combining the results of all genomes and individual patterns.
The output file is located in Results_versions, with the following nomenclature :
`all_results_${GlobalPattern}_v$(ls $Results_versions | wc -l).0.txt` taking into account the number of versions already present in the `Results_versions` folder.
The results file contains one line per reported genome sequence. Each line is structured in columns as follow:
- **genome** : genome name  
- **prot_id** : sequence ID 
- **annot** : sequence annotation 
- **global_pattern_RBVR** :  `Yes` if global pattern was found in the sequence. 
- **observed_pattern** :  real observed pattern using patterns codes  
- **one column for each pattern**, with pattern name as header and containing all patterns locations described as follow : {observed_pattern_sequence_1}:{start}-{stop}, {observed_pattern_sequence_2}:{start}-{stop}, etc...
- **distance**,this column is present only if `pattern_dist` is set to yes in [`config.txt`](https://github.com/cgbaboua/DGAT3_2023/blob/main/conf/config.txt) configuration file : distance between each patterns is calculated if it contain `xxx` and it's replaced by the real distance as : {observed_pattern_sequence_1}-{observed_pattern_sequence_2}:{distance}
- **length_seq** : length of sequence
- **sequence** : gene/protein sequence
